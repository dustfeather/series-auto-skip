name: Bump Version and Release Extension

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # also allow manual trigger

jobs:
  bump-version:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ðŸ§¾ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # needed to push tags

      - name: ðŸ”¼ Bump patch version in manifest.json
        id: bump
        run: |
          file="src/manifest.json"
          version=$(jq -r .version "$file")
          echo "Current version: $version"
          
          IFS='.' read -r major minor patch <<< "$version"
          patch=$((patch + 1))
          new_version="$major.$minor.$patch"
          echo "New version: $new_version"
          
          jq --arg v "$new_version" '.version = $v' "$file" > tmp && mv tmp "$file"
          echo "new_tag=v$new_version" >> $GITHUB_OUTPUT

      - name: ðŸ”– Commit and tag new version
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git commit -am "ci: bump version to ${{ steps.bump.outputs.new_tag }}"
          git tag ${{ steps.bump.outputs.new_tag }}
          git push origin HEAD
          git push origin ${{ steps.bump.outputs.new_tag }}

      - name: ðŸ“¦ Pack Extension for Chrome
        run: |
          mkdir -p dist
          cd src
          zip -r ../dist/extension-chrome.zip . -x '*.DS_Store'

      - name: ðŸ“¦ Pack Extension for Firefox
        run: |
          cp -r src src-firefox
          cd src-firefox
          zip -r ../dist/extension-firefox.zip . -x '*.DS_Store'

      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/extension-chrome.zip
            dist/extension-firefox.zip
