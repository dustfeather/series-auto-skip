name: Bump, Build, and Release Extension

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  bump-build-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Required for commits, tags, and releases

    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Needed to create tags

      - name: ðŸ”¼ Bump patch version in manifest.json
        id: bump
        run: |
          file="src/manifest.json"
          version=$(jq -r .version "$file")
          echo "Current version: $version"
          
          IFS='.' read -r major minor patch <<< "$version"
          patch=$((patch + 1))
          new_version="$major.$minor.$patch"
          echo "New version: $new_version"
          
          jq --arg v "$new_version" '.version = $v' "$file" > tmp && mv tmp "$file"
          echo "new_tag=v$new_version" >> $GITHUB_OUTPUT

      - name: ðŸ”– Commit and tag new version
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git commit -am "ci: bump version to ${{ steps.bump.outputs.new_tag }}"
          git tag ${{ steps.bump.outputs.new_tag }}
          git push origin HEAD
          git push origin ${{ steps.bump.outputs.new_tag }}

      - name: ðŸ“¦ Pack Chrome extension
        run: |
          mkdir -p dist
          cd src
          zip -r ../dist/extension-chrome.zip . -x '*.DS_Store'

      - name: ðŸ“¦ Pack Firefox extension
        run: |
          cp -r src src-firefox
          cd src-firefox
          zip -r ../dist/extension-firefox.zip . -x '*.DS_Store'

      - name: ðŸ• Wait for GitHub to recognize the tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag=${{ steps.bump.outputs.new_tag }}
          echo "Waiting for tag $tag to be available in GitHub API..."
          
          for i in {1..10}; do
            if gh release view "$tag" > /dev/null 2>&1; then
              echo "Tag $tag is ready."
              break
            fi
            echo "Retrying in 3s... ($i/10)"
            sleep 3
          done

      - name: ðŸš€ Create GitHub Release and upload zips
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.bump.outputs.new_tag }}
          name: Release ${{ steps.bump.outputs.new_tag }}
          files: |
            dist/extension-chrome.zip
            dist/extension-firefox.zip
